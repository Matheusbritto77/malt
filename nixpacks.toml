[phases.setup]
nixPkgs = [
    "nodejs_22", 
    "pnpm-10_x", 
    "git",
    "chromium",
    "nss",
    "atk",
    "at-spi2-atk",
    "libdrm",
    "libxkbcommon",
    "xorg.libXcomposite",
    "xorg.libXdamage",
    "xorg.libXrandr",
    "mesa",
    "alsa-lib",
    "pango",
    "cairo",
    "liberation_ttf",
    "noto-fonts-emoji",
    "go_1_22",
    "uv"
]

[phases.install]
cmds = ["pnpm install --no-frozen-lockfile", "pnpm ui:install"]

[phases.build]
cmds = [
  "CLAWDBOT_A2UI_SKIP_MISSING=1 pnpm build",
  "pnpm ui:build",
  "mkdir -p /app/data/.clawdbot /app/data/clawd",
  "cp .clawdbot.json /app/data/.clawdbot/moltbot.json || true"
]

[start]
cmd = "mkdir -p $CLAWDBOT_STATE_DIR $CLAWDBOT_WORKSPACE_DIR && ( [ ! -f $CLAWDBOT_STATE_DIR/moltbot.json ] && cp .clawdbot.json $CLAWDBOT_STATE_DIR/moltbot.json || true ) && node moltbot.mjs gateway run --bind lan --allow-unconfigured --port ${PORT:-80}"

[variables]
NODE_ENV = "production"
CLAWDBOT_PREFER_PNPM = "1"
CLAWDBOT_STATE_DIR = "/app/data/.clawdbot"
CLAWDBOT_WORKSPACE_DIR = "/app/data/clawd"
CLAWDBOT_NO_RESPAWN = "1"
CI = "true"
CLAWDBOT_GATEWAY_PORT = "$PORT"
CLAWDBOT_GATEWAY_TOKEN = "admin123"
# Browser headless settings - these override config file values
CLAWDBOT_BROWSER_HEADLESS = "true"
CLAWDBOT_BROWSER_NO_SANDBOX = "true"
# Chromium executable path (updated dynamically by nixpacks if needed)
CHROMIUM_EXECUTABLE_PATH = "/nix/var/nix/profiles/default/bin/chromium"
